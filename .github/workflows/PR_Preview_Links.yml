name: PR Preview Links

on:
  workflow_run:
    workflows: ["Windows MSVC x64", "Linux x86_64 (x86_64-linux-gnu)", "macOS x86_64"]
    types:
      - completed

jobs:
  post-preview-links:
    runs-on: ubuntu-latest
    # Only run if the triggering workflow was successful and part of a PR
    if: ${{ github.event.workflow_run.event == 'pull_request' && github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: 'Manage Preview Links'
        uses: actions/github-script@v6
        with:
          script: |
            const { owner, repo } = context.repo;
            const run_id = context.payload.workflow_run.id;
            const check_suite_id = context.payload.workflow_run.check_suite_id;
            const prNumber = context.payload.workflow_run.pull_requests[0].number;

            // 1. Fetch artifacts from the current successful run
            const allArtifacts = await github.rest.actions.listWorkflowRunArtifacts({
               owner,
               repo,
               run_id,
            });
            
            if (allArtifacts.data.artifacts.length === 0) return;

            // 2. Format the new links
            const newLinks = allArtifacts.data.artifacts.map(artifact => {
              return `* [${artifact.name}](https://github.com/${owner}/${repo}/suites/${check_suite_id}/artifacts/${artifact.id})`;
            }).join('\n');

            // 3. Find if we already posted a comment for this PR
            const comments = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: prNumber,
            });

            const botCommentHeader = "### ðŸ“¦ CI Build Preview (Desktop)";
            const existingComment = comments.data.find(c => c.body.startsWith(botCommentHeader));

            if (existingComment) {
              // Append logic: prevent duplicate links if the workflow was re-run
              let updatedBody = existingComment.body;
              allArtifacts.data.artifacts.forEach(artifact => {
                if (!updatedBody.includes(artifact.name)) {
                  updatedBody += `\n${newLinks}`;
                }
              });

              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existingComment.id,
                body: updatedBody
              });
            } else {
              // Create the initial comment
              const body = `${botCommentHeader}\n\nBuilds for this PR are ready for QA! You can download the desktop binaries for testing below:\n\n${newLinks}\n\n*Note: You must be logged into GitHub to download these artifacts.*`;
              
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body: body
              });
            }
